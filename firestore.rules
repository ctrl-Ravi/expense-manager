rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- USERS COLLECTION ---
    // Users can read/write their own profile.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- TRANSACTIONS COLLECTION ---
    // Participants (from/to) can read.
    // Authenticated users can create (we rely on app logic to set correct IDs, 
    // but ideally we'd validate 'from' == auth.uid OR 'to' == auth.uid).
    // Participants can update (e.g. editing details).
    match /transactions/{transactionId} {
      allow read: if request.auth != null && (
        resource.data.from == request.auth.uid || 
        resource.data.to == request.auth.uid
      );
      
      allow create: if request.auth != null && (
        request.resource.data.from == request.auth.uid || 
        request.resource.data.to == request.auth.uid
      );

      allow update: if request.auth != null && (
        resource.data.from == request.auth.uid || 
        resource.data.to == request.auth.uid
      );
    }
    
    // --- FRIEND REQUESTS COLLECTION ---
    // 'friend_requests' matches the code.
    match /friend_requests/{requestId} {
        // Allow reading if you are the sender or receiver
        allow read: if request.auth != null && (
            resource.data.from == request.auth.uid || 
            resource.data.to == request.auth.uid
        );
        
        // Allow creating if you are the sender
        allow create: if request.auth != null && request.resource.data.from == request.auth.uid;
        
        // Allow updating/deleting (accepting/rejecting) if you are involved
        allow write: if request.auth != null && (
            resource.data.from == request.auth.uid || 
            resource.data.to == request.auth.uid
        );
    }

    // --- INVITES COLLECTION ---
    // Used for link-based invites?
    match /invites/{inviteId} {
        allow read: if true; // Public for invite links to work
        allow create: if request.auth != null; // Only auth users creates
    }
  }
}
